"""
üéØ –¢–û–ß–ï–ß–ù–ê–Ø –î–ò–ê–ì–†–ê–ú–ú–ê (Scatter Plot)

–û–ø–∏—Å–∞–Ω–∏–µ:
    –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –≤–∑–∞–∏–º–æ—Å–≤—è–∑—å –º–µ–∂–¥—É –¥–≤—É–º—è –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–º–∏.
    –ö–∞–∂–¥–∞—è —Ç–æ—á–∫–∞ = –æ–¥–Ω–æ –Ω–∞–±–ª—é–¥–µ–Ω–∏–µ —Å –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º–∏ (x, y).

–ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:
    ‚úì –ù–∞–π—Ç–∏ –∫–æ—Ä—Ä–µ–ª—è—Ü–∏—é –º–µ–∂–¥—É –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–º–∏
    ‚úì –û–±–Ω–∞—Ä—É–∂–∏—Ç—å –≤—ã–±—Ä–æ—Å—ã
    ‚úì –ü–æ–∫–∞–∑–∞—Ç—å –∫–ª–∞—Å—Ç–µ—Ä—ã –∏ –≥—Ä—É–ø–ø—ã
    ‚úì –í–∏–∑—É–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –º–Ω–æ–≥–æ–º–µ—Ä–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ (—Ä–∞–∑–º–µ—Ä, —Ü–≤–µ—Ç —Ç–æ—á–µ–∫)

–ù–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:
    ‚úó –î–ª—è –∫–∞—Ç–µ–≥–æ—Ä–∏–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
    ‚úó –ö–æ–≥–¥–∞ —Ç–æ—á–µ–∫ —Å–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ (–æ–≤–µ—Ä–ø–ª–æ—Ç—Ç–∏–Ω–≥)
    ‚úó –î–ª—è –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ä—è–¥–æ–≤ (–ª—É—á—à–µ line plot)
"""

import matplotlib
matplotlib.use('Agg')
import matplotlib.pyplot as plt
import numpy as np


def create_scatter_plot(df, output_path='output/scatter_plot.png'):
    """
    –°–æ–∑–¥–∞–Ω–∏–µ —Ç–æ—á–µ—á–Ω–æ–π –¥–∏–∞–≥—Ä–∞–º–º—ã

    Args:
        df: DataFrame —Å –¥–∞–Ω–Ω—ã–º–∏
        output_path: –ø—É—Ç—å –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≥—Ä–∞—Ñ–∏–∫–∞
    """
    print("\n" + "="*80)
    print("üéØ –¢–û–ß–ï–ß–ù–ê–Ø –î–ò–ê–ì–†–ê–ú–ú–ê (Scatter Plot)")
    print("="*80)

    print("\nüí° Scatter plot –ø–æ–º–æ–≥–∞–µ—Ç –Ω–∞–π—Ç–∏ —Å–≤—è–∑—å –º–µ–∂–¥—É –¥–≤—É–º—è –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–º–∏.")
    print("   –ï—Å–ª–∏ —Ç–æ—á–∫–∏ –æ–±—Ä–∞–∑—É—é—Ç –ª–∏–Ω–∏—é - –µ—Å—Ç—å –∫–æ—Ä—Ä–µ–ª—è—Ü–∏—è!\n")

    fig, axes = plt.subplots(2, 2, figsize=(15, 10))
    fig.suptitle('–¢–æ—á–µ—á–Ω—ã–µ –¥–∏–∞–≥—Ä–∞–º–º—ã: –ø—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è', fontsize=16, fontweight='bold')

    # 1. –ü—Ä–æ—Å—Ç–∞—è —Ç–æ—á–µ—á–Ω–∞—è –¥–∏–∞–≥—Ä–∞–º–º–∞
    axes[0, 0].scatter(df['–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ'], df['–ü—Ä–æ–¥–∞–∂–∏'],
                      color='#3498DB', alpha=0.6, s=50, edgecolors='white', linewidth=0.5)
    axes[0, 0].set_title('1Ô∏è‚É£ –ü—Ä–æ—Å—Ç–∞—è —Ç–æ—á–µ—á–Ω–∞—è –¥–∏–∞–≥—Ä–∞–º–º–∞')
    axes[0, 0].set_xlabel('–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ–≤–∞—Ä–æ–≤')
    axes[0, 0].set_ylabel('–ü—Ä–æ–¥–∞–∂–∏ (—Ä—É–±.)')
    axes[0, 0].grid(True, alpha=0.3)

    # –î–æ–±–∞–≤–ª—è–µ–º –ª–∏–Ω–∏—é —Ç—Ä–µ–Ω–¥–∞
    z = np.polyfit(df['–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ'], df['–ü—Ä–æ–¥–∞–∂–∏'], 1)
    p = np.poly1d(z)
    axes[0, 0].plot(df['–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ'].sort_values(),
                   p(df['–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ'].sort_values()),
                   "r--", linewidth=2, label='–õ–∏–Ω–∏—è —Ç—Ä–µ–Ω–¥–∞')
    axes[0, 0].legend()

    # –í—ã—á–∏—Å–ª—è–µ–º –∫–æ—Ä—Ä–µ–ª—è—Ü–∏—é
    correlation = df['–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ'].corr(df['–ü—Ä–æ–¥–∞–∂–∏'])
    axes[0, 0].text(0.05, 0.95, f'–ö–æ—Ä—Ä–µ–ª—è—Ü–∏—è: {correlation:.3f}',
                   transform=axes[0, 0].transAxes,
                   bbox=dict(boxstyle='round', facecolor='wheat', alpha=0.5),
                   verticalalignment='top')

    # 2. Scatter —Å —Ü–≤–µ—Ç–æ–º –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º
    colors = ['#E74C3C', '#3498DB', '#2ECC71', '#F39C12']
    for i, category in enumerate(df['–ö–∞—Ç–µ–≥–æ—Ä–∏—è'].unique()):
        cat_data = df[df['–ö–∞—Ç–µ–≥–æ—Ä–∏—è'] == category]
        axes[0, 1].scatter(cat_data['–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ'], cat_data['–ü—Ä–æ–¥–∞–∂–∏'],
                         color=colors[i], alpha=0.6, s=50,
                         label=category, edgecolors='white', linewidth=0.5)
    axes[0, 1].set_title('2Ô∏è‚É£ –° —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ–º –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º')
    axes[0, 1].set_xlabel('–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ–≤–∞—Ä–æ–≤')
    axes[0, 1].set_ylabel('–ü—Ä–æ–¥–∞–∂–∏ (—Ä—É–±.)')
    axes[0, 1].legend()
    axes[0, 1].grid(True, alpha=0.3)

    # 3. Bubble chart (—Ä–∞–∑–º–µ—Ä —Ç–æ—á–µ–∫ = —Ç—Ä–µ—Ç—å—è –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è)
    sizes = df['–°—Ä–µ–¥–Ω—è—è_—Ü–µ–Ω–∞'] / 10  # –ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º —Ä–∞–∑–º–µ—Ä
    scatter = axes[1, 0].scatter(df['–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ'], df['–ü—Ä–æ–¥–∞–∂–∏'],
                                s=sizes, alpha=0.5,
                                c=df['–°—Ä–µ–¥–Ω—è—è_—Ü–µ–Ω–∞'], cmap='viridis',
                                edgecolors='white', linewidth=1)
    axes[1, 0].set_title('3Ô∏è‚É£ –ü—É–∑—ã—Ä—å–∫–æ–≤–∞—è –¥–∏–∞–≥—Ä–∞–º–º–∞ (Bubble Chart)')
    axes[1, 0].set_xlabel('–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ–≤–∞—Ä–æ–≤')
    axes[1, 0].set_ylabel('–ü—Ä–æ–¥–∞–∂–∏ (—Ä—É–±.)')
    plt.colorbar(scatter, ax=axes[1, 0], label='–°—Ä–µ–¥–Ω—è—è —Ü–µ–Ω–∞ (—Ä—É–±.)')
    axes[1, 0].grid(True, alpha=0.3)

    # 4. Scatter —Å –º–∞—Ä–∫–µ—Ä–∞–º–∏ –ø–æ —Ä–µ–≥–∏–æ–Ω–∞–º
    markers = ['o', 's', '^']
    regions = df['–†–µ–≥–∏–æ–Ω'].unique()
    for i, region in enumerate(regions):
        region_data = df[df['–†–µ–≥–∏–æ–Ω'] == region]
        axes[1, 1].scatter(region_data['–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ'], region_data['–ü—Ä–æ–¥–∞–∂–∏'],
                         marker=markers[i % len(markers)], alpha=0.6,
                         s=60, label=region, edgecolors='white', linewidth=0.5)
    axes[1, 1].set_title('4Ô∏è‚É£ –° —Ä–∞–∑–Ω—ã–º–∏ –º–∞—Ä–∫–µ—Ä–∞–º–∏')
    axes[1, 1].set_xlabel('–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ–≤–∞—Ä–æ–≤')
    axes[1, 1].set_ylabel('–ü—Ä–æ–¥–∞–∂–∏ (—Ä—É–±.)')
    axes[1, 1].legend()
    axes[1, 1].grid(True, alpha=0.3)

    plt.tight_layout()
    plt.savefig(output_path, dpi=300, bbox_inches='tight')
    print(f"‚úÖ –ì—Ä–∞—Ñ–∏–∫ —Å–æ—Ö—Ä–∞–Ω–µ–Ω: {output_path}")

    # –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∫–æ—Ä—Ä–µ–ª—è—Ü–∏–∏
    print("\nüìä –ö–æ—Ä—Ä–µ–ª—è—Ü–∏–æ–Ω–Ω—ã–π –∞–Ω–∞–ª–∏–∑:")
    print(f"   ‚Ä¢ –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ ‚Üî –ü—Ä–æ–¥–∞–∂–∏: {df['–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ'].corr(df['–ü—Ä–æ–¥–∞–∂–∏']):.3f}")
    print(f"   ‚Ä¢ –°—Ä–µ–¥–Ω—è—è —Ü–µ–Ω–∞ ‚Üî –ü—Ä–æ–¥–∞–∂–∏: {df['–°—Ä–µ–¥–Ω—è—è_—Ü–µ–Ω–∞'].corr(df['–ü—Ä–æ–¥–∞–∂–∏']):.3f}")

    print("\nüí° –ò–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏—è –∫–æ—Ä—Ä–µ–ª—è—Ü–∏–∏:")
    print("   ‚Ä¢ +1.0 = –∏–¥–µ–∞–ª—å–Ω–∞—è –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–∞—è —Å–≤—è–∑—å")
    print("   ‚Ä¢  0.0 = –Ω–µ—Ç —Å–≤—è–∑–∏")
    print("   ‚Ä¢ -1.0 = –∏–¥–µ–∞–ª—å–Ω–∞—è –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω–∞—è —Å–≤—è–∑—å")

    plt.close()

    return output_path


def get_code_example():
    """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø—Ä–∏–º–µ—Ä—ã –∫–æ–¥–∞ –¥–ª—è –æ–±—É—á–µ–Ω–∏—è"""
    return {
        'title': '–¢–æ—á–µ—á–Ω–∞—è –¥–∏–∞–≥—Ä–∞–º–º–∞ (Scatter Plot)',
        'description': '–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∫–æ—Ä—Ä–µ–ª—è—Ü–∏—é –º–µ–∂–¥—É –¥–≤—É–º—è –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–º–∏',
        'when_use': '–°–≤—è–∑–∏ –º–µ–∂–¥—É –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–º–∏, –∫–æ—Ä—Ä–µ–ª—è—Ü–∏–∏',
        'examples': [
            {
                'name': '1Ô∏è‚É£ –ü—Ä–æ—Å—Ç–∞—è —Ç–æ—á–µ—á–Ω–∞—è',
                'code': '''# –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö
x = df['–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ']
y = df['–ü—Ä–æ–¥–∞–∂–∏']

# –°–æ–∑–¥–∞–Ω–∏–µ –≥—Ä–∞—Ñ–∏–∫–∞
fig, ax = plt.subplots(figsize=(10, 6))
ax.scatter(x, y,
           c='skyblue',           # –¶–≤–µ—Ç —Ç–æ—á–µ–∫
           s=50,                  # –†–∞–∑–º–µ—Ä —Ç–æ—á–µ–∫
           alpha=0.6,             # –ü—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å
           edgecolors='navy',     # –¶–≤–µ—Ç –≥—Ä–∞–Ω–∏—Ü
           linewidth=0.5)

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞
ax.set_title('–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç—å: –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ vs –ü—Ä–æ–¥–∞–∂–∏')
ax.set_xlabel('–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –µ–¥–∏–Ω–∏—Ü')
ax.set_ylabel('–ü—Ä–æ–¥–∞–∂–∏ (—Ä—É–±.)')
ax.grid(True, alpha=0.3)

plt.tight_layout()
plt.savefig('scatter_simple.png', dpi=300)'''
            },
            {
                'name': '2Ô∏è‚É£ –° —Ü–≤–µ—Ç–æ–º –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º',
                'code': '''# –°–æ–∑–¥–∞–Ω–∏–µ –≥—Ä–∞—Ñ–∏–∫–∞
fig, ax = plt.subplots(figsize=(10, 6))

# –¶–≤–µ—Ç–∞ –¥–ª—è –∫–∞—Ç–µ–≥–æ—Ä–∏–π
colors = {'–≠–ª–µ–∫—Ç—Ä–æ–Ω–∏–∫–∞': '#FF6B6B',
          '–û–¥–µ–∂–¥–∞': '#4ECDC4',
          '–ü—Ä–æ–¥—É–∫—Ç—ã': '#45B7D1',
          '–ö–Ω–∏–≥–∏': '#FFA07A'}

# –†–∏—Å—É–µ–º —Ç–æ—á–∫–∏ –¥–ª—è –∫–∞–∂–¥–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
for category in df['–ö–∞—Ç–µ–≥–æ—Ä–∏—è'].unique():
    cat_data = df[df['–ö–∞—Ç–µ–≥–æ—Ä–∏—è'] == category]
    ax.scatter(cat_data['–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ'],
               cat_data['–ü—Ä–æ–¥–∞–∂–∏'],
               c=colors.get(category, 'gray'),
               label=category,
               s=60,
               alpha=0.6,
               edgecolors='white',
               linewidth=0.5)

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞
ax.set_title('–ü—Ä–æ–¥–∞–∂–∏ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º')
ax.set_xlabel('–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –µ–¥–∏–Ω–∏—Ü')
ax.set_ylabel('–ü—Ä–æ–¥–∞–∂–∏ (—Ä—É–±.)')
ax.legend()
ax.grid(True, alpha=0.3)

plt.tight_layout()
plt.savefig('scatter_colored.png', dpi=300)'''
            },
            {
                'name': '3Ô∏è‚É£ –° —Ä–∞–∑–º–µ—Ä–æ–º —Ç–æ—á–µ–∫ (bubble)',
                'code': '''# –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö
x = df['–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ']
y = df['–ü—Ä–æ–¥–∞–∂–∏']
sizes = df['–°—Ä–µ–¥–Ω—è—è_—Ü–µ–Ω–∞'] / 10  # –†–∞–∑–º–µ—Ä –ø—Ä–æ–ø–æ—Ä—Ü–∏–æ–Ω–∞–ª–µ–Ω —Ü–µ–Ω–µ

# –°–æ–∑–¥–∞–Ω–∏–µ –≥—Ä–∞—Ñ–∏–∫–∞
fig, ax = plt.subplots(figsize=(10, 6))

scatter = ax.scatter(x, y,
                     s=sizes,             # –†–∞–∑–º–µ—Ä —Ç–æ—á–µ–∫
                     c=df['–°—Ä–µ–¥–Ω—è—è_—Ü–µ–Ω–∞'], # –¶–≤–µ—Ç –ø–æ —Ü–µ–Ω–µ
                     cmap='viridis',       # –¶–≤–µ—Ç–æ–≤–∞—è –∫–∞—Ä—Ç–∞
                     alpha=0.6,
                     edgecolors='white',
                     linewidth=1)

# –î–æ–±–∞–≤–ª—è–µ–º colorbar
cbar = plt.colorbar(scatter, ax=ax)
cbar.set_label('–°—Ä–µ–¥–Ω—è—è —Ü–µ–Ω–∞ (—Ä—É–±.)')

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞
ax.set_title('–ü—É–∑—ã—Ä—å–∫–æ–≤–∞—è –¥–∏–∞–≥—Ä–∞–º–º–∞ (—Ä–∞–∑–º–µ—Ä = —Ü–µ–Ω–∞)')
ax.set_xlabel('–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –µ–¥–∏–Ω–∏—Ü')
ax.set_ylabel('–ü—Ä–æ–¥–∞–∂–∏ (—Ä—É–±.)')
ax.grid(True, alpha=0.3)

plt.tight_layout()
plt.savefig('scatter_bubble.png', dpi=300)'''
            },
            {
                'name': '4Ô∏è‚É£ –° –ª–∏–Ω–∏–µ–π —Ç—Ä–µ–Ω–¥–∞',
                'code': '''# –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö
x = df['–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ']
y = df['–ü—Ä–æ–¥–∞–∂–∏']

# –°–æ–∑–¥–∞–Ω–∏–µ –≥—Ä–∞—Ñ–∏–∫–∞
fig, ax = plt.subplots(figsize=(10, 6))

# –¢–æ—á–∫–∏
ax.scatter(x, y,
           c='skyblue',
           s=50,
           alpha=0.6,
           edgecolors='navy',
           linewidth=0.5,
           label='–î–∞–Ω–Ω—ã–µ')

# –õ–∏–Ω–∏—è —Ç—Ä–µ–Ω–¥–∞
z = np.polyfit(x, y, 1)  # –ü–æ–ª–∏–Ω–æ–º 1-–π —Å—Ç–µ–ø–µ–Ω–∏ (–ª–∏–Ω–∏—è)
p = np.poly1d(z)
ax.plot(x.sort_values(), p(x.sort_values()),
        "r--", linewidth=2, label='–¢—Ä–µ–Ω–¥')

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞
ax.set_title('–ö–æ—Ä—Ä–µ–ª—è—Ü–∏—è —Å –ª–∏–Ω–∏–µ–π —Ç—Ä–µ–Ω–¥–∞')
ax.set_xlabel('–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –µ–¥–∏–Ω–∏—Ü')
ax.set_ylabel('–ü—Ä–æ–¥–∞–∂–∏ (—Ä—É–±.)')
ax.legend()
ax.grid(True, alpha=0.3)

plt.tight_layout()
plt.savefig('scatter_trend.png', dpi=300)'''
            }
        ],
        'tips': [
            'üí° s –ø–∞—Ä–∞–º–µ—Ç—Ä –∑–∞–¥–∞–µ—Ç —Ä–∞–∑–º–µ—Ä —Ç–æ—á–µ–∫',
            'üí° c –º–æ–∂–µ—Ç –±—ã—Ç—å —Ü–≤–µ—Ç–æ–º –∏–ª–∏ –º–∞—Å—Å–∏–≤–æ–º –¥–ª—è –≥—Ä–∞–¥–∏–µ–Ω—Ç–∞',
            'üí° alpha=0.6 –ø–æ–º–æ–≥–∞–µ—Ç –≤–∏–¥–µ—Ç—å –Ω–∞–ª–æ–∂–µ–Ω–∏—è',
            'üí° np.polyfit() —Å–æ–∑–¥–∞–µ—Ç –ª–∏–Ω–∏—é —Ç—Ä–µ–Ω–¥–∞',
            'üí° cmap –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Ü–≤–µ—Ç–æ–≤—É—é —Å—Ö–µ–º—É'
        ]
    }
