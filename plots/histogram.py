"""
üìâ –ì–ò–°–¢–û–ì–†–ê–ú–ú–ê (Histogram)

–û–ø–∏—Å–∞–Ω–∏–µ:
    –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –Ω–µ–ø—Ä–µ—Ä—ã–≤–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö.
    –î–∞–Ω–Ω—ã–µ –≥—Ä—É–ø–ø–∏—Ä—É—é—Ç—Å—è –≤ –∏–Ω—Ç–µ—Ä–≤–∞–ª—ã (bins), –≤—ã—Å–æ—Ç–∞ —Å—Ç–æ–ª–±—Ü–∞ = —á–∞—Å—Ç–æ—Ç–∞.

–ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:
    ‚úì –ü–æ–∫–∞–∑–∞—Ç—å —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
    ‚úì –ù–∞–π—Ç–∏ –≤—ã–±—Ä–æ—Å—ã –∏ –∞–Ω–æ–º–∞–ª–∏–∏
    ‚úì –ü–æ–Ω—è—Ç—å —Ñ–æ—Ä–º—É —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è (–Ω–æ—Ä–º–∞–ª—å–Ω–æ–µ, —Å–∫–æ—à–µ–Ω–Ω–æ–µ)
    ‚úì –ê–Ω–∞–ª–∏–∑ —á–∞—Å—Ç–æ—Ç—ã –ø–æ—è–≤–ª–µ–Ω–∏—è –∑–Ω–∞—á–µ–Ω–∏–π

–ù–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:
    ‚úó –î–ª—è –∫–∞—Ç–µ–≥–æ—Ä–∏–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö (–∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ bar plot)
    ‚úó –î–ª—è –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ä—è–¥–æ–≤
    ‚úó –î–ª—è –ø–æ–∫–∞–∑–∞ —Ç–æ—á–Ω—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π
"""

import matplotlib
matplotlib.use('Agg')
import matplotlib.pyplot as plt
import numpy as np


def create_histogram(df, output_path='output/histogram.png'):
    """
    –°–æ–∑–¥–∞–Ω–∏–µ –≥–∏—Å—Ç–æ–≥—Ä–∞–º–º—ã

    Args:
        df: DataFrame —Å –¥–∞–Ω–Ω—ã–º–∏
        output_path: –ø—É—Ç—å –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≥—Ä–∞—Ñ–∏–∫–∞
    """
    print("\n" + "="*80)
    print("üìâ –ì–ò–°–¢–û–ì–†–ê–ú–ú–ê (Histogram)")
    print("="*80)

    print("\nüí° –ì–∏—Å—Ç–æ–≥—Ä–∞–º–º–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç, –∫–∞–∫ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω—ã –≤–∞—à–∏ –¥–∞–Ω–Ω—ã–µ.")
    print("   –ü–æ–º–æ–≥–∞–µ—Ç –Ω–∞–π—Ç–∏ —Å—Ä–µ–¥–Ω–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ, –≤—ã–±—Ä–æ—Å—ã –∏ –ø–æ–Ω—è—Ç—å —Ñ–æ—Ä–º—É —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è.\n")

    fig, axes = plt.subplots(2, 2, figsize=(15, 10))
    fig.suptitle('–ì–∏—Å—Ç–æ–≥—Ä–∞–º–º—ã: –ø—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è', fontsize=16, fontweight='bold')

    # 1. –ü—Ä–æ—Å—Ç–∞—è –≥–∏—Å—Ç–æ–≥—Ä–∞–º–º–∞
    axes[0, 0].hist(df['–°—Ä–µ–¥–Ω—è—è_—Ü–µ–Ω–∞'], bins=30, color='#3498DB',
                   edgecolor='white', linewidth=1.5, alpha=0.7)
    axes[0, 0].set_title('1Ô∏è‚É£ –ü—Ä–æ—Å—Ç–∞—è –≥–∏—Å—Ç–æ–≥—Ä–∞–º–º–∞')
    axes[0, 0].set_xlabel('–°—Ä–µ–¥–Ω—è—è —Ü–µ–Ω–∞ (—Ä—É–±.)')
    axes[0, 0].set_ylabel('–ß–∞—Å—Ç–æ—Ç–∞')
    axes[0, 0].grid(axis='y', alpha=0.3)

    # –î–æ–±–∞–≤–ª—è–µ–º —Å—Ä–µ–¥–Ω–µ–µ –∏ –º–µ–¥–∏–∞–Ω—É
    mean_price = df['–°—Ä–µ–¥–Ω—è—è_—Ü–µ–Ω–∞'].mean()
    median_price = df['–°—Ä–µ–¥–Ω—è—è_—Ü–µ–Ω–∞'].median()
    axes[0, 0].axvline(mean_price, color='red', linestyle='--',
                      linewidth=2, label=f'–°—Ä–µ–¥–Ω–µ–µ: {mean_price:.0f}')
    axes[0, 0].axvline(median_price, color='green', linestyle='--',
                      linewidth=2, label=f'–ú–µ–¥–∏–∞–Ω–∞: {median_price:.0f}')
    axes[0, 0].legend()

    # 2. –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–π
    for category in df['–ö–∞—Ç–µ–≥–æ—Ä–∏—è'].unique()[:3]:  # –ë–µ—Ä–µ–º 3 –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
        cat_data = df[df['–ö–∞—Ç–µ–≥–æ—Ä–∏—è'] == category]['–°—Ä–µ–¥–Ω—è—è_—Ü–µ–Ω–∞']
        axes[0, 1].hist(cat_data, bins=20, alpha=0.5, label=category, edgecolor='white')
    axes[0, 1].set_title('2Ô∏è‚É£ –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–π')
    axes[0, 1].set_xlabel('–°—Ä–µ–¥–Ω—è—è —Ü–µ–Ω–∞ (—Ä—É–±.)')
    axes[0, 1].set_ylabel('–ß–∞—Å—Ç–æ—Ç–∞')
    axes[0, 1].legend()
    axes[0, 1].grid(axis='y', alpha=0.3)

    # 3. –ì–∏—Å—Ç–æ–≥—Ä–∞–º–º–∞ —Å –∫—Ä–∏–≤–æ–π –ø–ª–æ—Ç–Ω–æ—Å—Ç–∏ (KDE)
    n, bins, patches = axes[1, 0].hist(df['–ü—Ä–æ–¥–∞–∂–∏'], bins=30,
                                       color='#E74C3C', alpha=0.6,
                                       edgecolor='white', linewidth=1.5,
                                       density=True)

    # –î–æ–±–∞–≤–ª—è–µ–º –∫—Ä–∏–≤—É—é –ø–ª–æ—Ç–Ω–æ—Å—Ç–∏
    from scipy import stats
    mu = df['–ü—Ä–æ–¥–∞–∂–∏'].mean()
    sigma = df['–ü—Ä–æ–¥–∞–∂–∏'].std()
    x = np.linspace(df['–ü—Ä–æ–¥–∞–∂–∏'].min(), df['–ü—Ä–æ–¥–∞–∂–∏'].max(), 100)
    axes[1, 0].plot(x, stats.norm.pdf(x, mu, sigma),
                   'k--', linewidth=2, label='–ù–æ—Ä–º–∞–ª—å–Ω–æ–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ')

    axes[1, 0].set_title('3Ô∏è‚É£ –° –∫—Ä–∏–≤–æ–π –ø–ª–æ—Ç–Ω–æ—Å—Ç–∏')
    axes[1, 0].set_xlabel('–ü—Ä–æ–¥–∞–∂–∏ (—Ä—É–±.)')
    axes[1, 0].set_ylabel('–ü–ª–æ—Ç–Ω–æ—Å—Ç—å –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç–∏')
    axes[1, 0].legend()
    axes[1, 0].grid(axis='y', alpha=0.3)

    # 4. –ö—É–º—É–ª—è—Ç–∏–≤–Ω–∞—è –≥–∏—Å—Ç–æ–≥—Ä–∞–º–º–∞
    axes[1, 1].hist(df['–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ'], bins=20, color='#1ABC9C',
                   edgecolor='white', linewidth=1.5, alpha=0.7,
                   cumulative=True)
    axes[1, 1].set_title('4Ô∏è‚É£ –ö—É–º—É–ª—è—Ç–∏–≤–Ω–∞—è –≥–∏—Å—Ç–æ–≥—Ä–∞–º–º–∞')
    axes[1, 1].set_xlabel('–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ–≤–∞—Ä–æ–≤')
    axes[1, 1].set_ylabel('–ù–∞–∫–æ–ø–ª–µ–Ω–Ω–∞—è —á–∞—Å—Ç–æ—Ç–∞')
    axes[1, 1].grid(axis='y', alpha=0.3)

    plt.tight_layout()
    plt.savefig(output_path, dpi=300, bbox_inches='tight')
    print(f"‚úÖ –ì—Ä–∞—Ñ–∏–∫ —Å–æ—Ö—Ä–∞–Ω–µ–Ω: {output_path}")

    # –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
    print("\nüìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Ü–µ–Ω:")
    print(f"   ‚Ä¢ –°—Ä–µ–¥–Ω–µ–µ: {df['–°—Ä–µ–¥–Ω—è—è_—Ü–µ–Ω–∞'].mean():.2f} —Ä—É–±.")
    print(f"   ‚Ä¢ –ú–µ–¥–∏–∞–Ω–∞: {df['–°—Ä–µ–¥–Ω—è—è_—Ü–µ–Ω–∞'].median():.2f} —Ä—É–±.")
    print(f"   ‚Ä¢ –°—Ç–¥. –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ: {df['–°—Ä–µ–¥–Ω—è—è_—Ü–µ–Ω–∞'].std():.2f} —Ä—É–±.")
    print(f"   ‚Ä¢ –ú–∏–Ω–∏–º—É–º: {df['–°—Ä–µ–¥–Ω—è—è_—Ü–µ–Ω–∞'].min():.2f} —Ä—É–±.")
    print(f"   ‚Ä¢ –ú–∞–∫—Å–∏–º—É–º: {df['–°—Ä–µ–¥–Ω—è—è_—Ü–µ–Ω–∞'].max():.2f} —Ä—É–±.")

    print("\nüí° –°–æ–≤–µ—Ç: –ï—Å–ª–∏ –≥–∏—Å—Ç–æ–≥—Ä–∞–º–º–∞ —Å–∏–º–º–µ—Ç—Ä–∏—á–Ω–∞ - —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –±–ª–∏–∑–∫–æ –∫ –Ω–æ—Ä–º–∞–ª—å–Ω–æ–º—É!")

    plt.close()

    return output_path
